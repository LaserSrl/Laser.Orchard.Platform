(function(n){n.widget("ui.tagit",{options:{tagSource:[],triggerKeys:["enter","space","comma","tab"],initialTags:[],minLength:1,select:!1,allowNewTags:!0,caseSensitive:!1,sortable:!1,highlightOnExistColor:"#0F0",emptySearch:!0,tagsChanged:function(){}},_splitAt:/\ |,/g,_existingAtIndex:0,_pasteMetaKeyPressed:!1,_keys:{backspace:[8],enter:[13],space:[32],comma:[44,188],tab:[9]},_sortable:{sorting:-1},_create:function(){var t=this,r,i;this.tagsArray=[];this.timer=null;this.element.addClass("tagit");this.element.children("li").each(function(){var i=n(this),r=i.attr("tagValue");t.options.initialTags.push({label:i.text(),value:r?r:i.text()})});t._splitAt=null;n.inArray("space",t.options.triggerKeys)>0&&n.inArray("comma",t.options.triggerKeys)>0?t._splitAt=/\ |,/g:n.inArray("space",t.options.triggerKeys)>0?t._splitAt=/\ /g:n.inArray("comma",t.options.triggerKeys)>0&&(t._splitAt=/,/g);this.element.html('<li class="tagit-new"><input class="tagit-input" type="text" /><\/li>');this.input=this.element.find(".tagit-input");n(this.element).click(function(i){if(n(i.target).hasClass("tagit-close")){var u=n(i.target).parent(),r=t.tagsArray[u.index()];r.element.remove();t._popTag(r)}else t.input.focus(),t.options.emptySearch&&n(i.target).hasClass("tagit-input")&&t.input.val()==""&&t.input.autocomplete!=undefined&&t.input.autocomplete("search","")});r=this.options.select;this.options.appendTo=this.element;this.options.source=this.options.tagSource;this.options.select=function(n,i){return t.input.data("autoCompleteTag",!0),clearTimeout(t.timer),i.item.label===undefined?t._addTag(i.item.value):t._addTag(i.item.label,i.item.value),!1};this.options.focus=function(n,i){if(i.item.label!==undefined&&/^key/.test(n.originalEvent.type))return t.input.val(i.item.label),t.input.attr("tagValue",i.item.value),!1};this.options.autoFocus=!this.options.allowNewTags;this.input.autocomplete(this.options);this.options.select=r;this.input.keydown(function(i){var r=t.element.children(".tagit-choice:last");if(i.which==t._keys.backspace)return t._backspace(r);!t._isInitKey(i.which)||t._isTabKey(i.which)&&this.value==""&&!t.input.data("autoCompleteTag")||(i.preventDefault(),t.input.data("autoCompleteTag",!1),t.options.allowNewTags&&(t.options.maxTags===undefined||t.tagsArray.length!=t.options.maxTags)?t.options.allowNewTags&&n(this).val().length>=t.options.minLength&&t._addTag(n(this).val()):t.input.val(""));t.options.maxLength!==undefined&&t.input.val().length==t.options.maxLength&&i.preventDefault();r.hasClass("selected")&&r.removeClass("selected");t._pasteMetaKeyPressed=i.metaKey;t.lastKey=i.which});this.input.keyup(function(i){t._pasteMetaKeyPressed&&(i.which==91||i.which==86)&&n(this).blur();window.setTimeout(function(){t._pasteMetaKeyPressed=i.metaKey},250)});this.input.blur(function(){return t.currentLabel=n(this).val(),t.currentValue=n(this).attr("tagValue"),t.options.allowNewTags&&(t.timer=setTimeout(function(){t._addTag(t.currentLabel,t.currentValue);t.currentValue="";t.currentLabel=""},400)),n(this).val("").removeAttr("tagValue"),!1});String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});this.options.select&&(this.select=n('<select class="tagit-hiddenSelect" name="'+this.element.attr("name")+'" multiple="multiple"><\/select>'),this.element.after(this.select));this._initialTags();t.options.sortable!==!1&&(i={items:".tagit-choice",containment:"parent",opacity:.6,tolerance:"pointer",start:function(i,r){t._sortable.tag=n(r.item);t._sortable.origIndex=t._sortable.tag.index()},update:function(){if(t._sortable.newIndex=t._sortable.tag.index(),t._moveTag(t._sortable.origIndex,t._sortable.newIndex),t.options.tagsChanged){var n=t.tagsArray[t._sortable.newIndex];t.options.tagsChanged(n.value,"moved",n.element)}}},t.options.sortable=="handle"&&(i.handle="a.ui-icon",i.cursor="move"),t.element.sortable(i))},_popSelect:function(t){n("option:eq("+t.index+")",this.select).remove();this.select.change()},_addSelect:function(n){this.select.append('<option selected="selected" value="'+n.value+'">'+n.label+"<\/option>");this.select.change()},_popTag:function(n){n===undefined?n=this.tagsArray.pop():this.tagsArray.splice(n.index,1);for(var t in this.tagsArray)this.tagsArray[t].index=t;this.options.select&&this._popSelect(n);this.options.tagsChanged&&this.options.tagsChanged(n.value||n.label,"popped",n);return},_addTag:function(t,i){var f,u,e,r;if(this.input.autocomplete("close").val(""),this._splitAt&&t.search(this._splitAt)>0){for(f=t.split(this._splitAt),u=0;u<f.length;u++)this._addTag(f[u],i);return}return(t=t.replace(/,+$/,"").trim(),t=="")?!1:(e=this._exists(t,i),e!==!1)?(this._highlightExisting(e),!1):(r=this.tag(t,i),r.element=n('<li class="tagit-choice"'+(i!==undefined?' tagValue="'+i+'"':"")+">"+(this.options.sortable=="handle"?'<a class="ui-icon ui-icon-grip-dotted-vertical" style="float:left"><\/a>':"")+t+'<a class="tagit-close">x<\/a><\/li>'),r.element.insertBefore(this.input.parent()),this.tagsArray.push(r),this.input.val(""),this.options.select&&this._addSelect(r),this.options.tagsChanged&&this.options.tagsChanged(r.label,"added",r),!0)},_exists:function(n,t){if(this.tagsArray.length==0)return!1;n=this._lowerIfCaseInsensitive(n);t=this._lowerIfCaseInsensitive(t);for(var i in this.tagsArray)if(this._lowerIfCaseInsensitive(this.tagsArray[i].label)==n)if(t!==undefined){if(this._lowerIfCaseInsensitive(this.tagsArray[i].value)==t)return i}else return i;return!1},_highlightExisting:function(n){var t,i;this.options.highlightOnExistColor!==undefined&&(t=this.tagsArray[n],t.element.stop(),i=t.element.css("color"),t.element.animate({color:this.options.highlightOnExistColor},100).animate({color:i},800))},_isInitKey:function(t){var i="";for(var r in this._keys)n.inArray(t,this._keys[r])!=-1&&(i=r);return n.inArray(i,this.options.triggerKeys)!=-1?!0:!1},_isTabKey:function(t){var i=this._keys.tab;return n.inArray(t,i)>-1},_removeTag:function(){this._popTag();this.element.children(".tagit-choice:last").remove()},_backspace:function(n){return this.input.val()==""&&(this.lastKey==this._keys.backspace?(this._popTag(),n.remove(),this.lastKey=null):(n.addClass("selected"),this.lastKey=this._keys.backspace)),!0},_initialTags:function(){var t=this,i;this.options.tagsChanged&&(i=this.options.tagsChanged);this.options.tagsChanged=null;this.options.initialTags.length!=0&&n(this.options.initialTags).each(function(n,i){typeof i=="object"?t._addTag(i.label,i.value):t._addTag(i)});this.options.tagsChanged=i},_lowerIfCaseInsensitive:function(n){return n===undefined||typeof n!="string"?n:this.options.caseSensitive?n:n.toLowerCase()},_moveTag:function(t,i){this.tagsArray.splice(i,0,this.tagsArray.splice(t,1)[0]);for(var r in this.tagsArray)this.tagsArray[r].index=r;this.options.select&&n("option:eq("+t+")",this.select).insertBefore(n("option:eq("+i+")",this.select))},tags:function(){return this.tagsArray},destroy:function(){n.Widget.prototype.destroy.apply(this,arguments);this.tagsArray=[]},reset:function(){this.element.find(".tagit-choice").remove();this.tagsArray=[];this.options.select&&(this.select.children().remove(),this.select.change());this._initialTags();this.options.tagsChanged&&this.options.tagsChanged(null,"reset",null)},fill:function(n){n!==undefined&&(this.options.initialTags=n);this.reset()},add:function(n,t){return typeof n=="object"?this._addTag({label:n,value:t}):this._addTag(n,t)},tag:function(n,t,i){var r=this;return{label:n,value:t===undefined?n:t,element:i,index:r.tagsArray.length}}})})(jQuery);